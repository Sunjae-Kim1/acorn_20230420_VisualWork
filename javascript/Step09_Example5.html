<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Step09_Example5.html</title>
    <style>
        canvas{
            border: 1px solid red;
        }
    </style>
</head>
<body>
    <h1> canvas 요소 활용 </h1>
    <!-- canvas 요소는 width , height 속성 지정 가능 -->
    <canvas id="myCanvas" width="800" height="500"></canvas>
    <script>
        /*
            const 는 constant 의 약자
            변수에 값이 한번 당기면 그 이후에 변경을 불가능하게 하는 예약어
            즉 변수를 상수화하는 기능이다. 

            const num = 10;
            num = 20; // 변경 불가 ( 에러 )

            const names = {"김구라" , "해골" , "원숭이"};
            names = {"lee" , "park"}; // 변경 불가 ( 에러 )
            names[0] = "이정호" // 가능

            const mem = {num:1};
            mem = {num:2}; // 변경 불가 ( 에러 )
            mem.num = 3; // 가능
        */

        // canvas 요소 참조값
        const canvas = document.querySelector("#myCanvas");
        // canvas 에 그림 그릴 도구 (context) 객체 얻기
        const context = canvas.getContext("2d");

        // canvas 에 그릴 이미지 로딩
        const snipeImg = new Image();
        snipeImg.src = "images/snipe.png";
        // 총알 구멍 이미지
        const holeImg = new Image();
        holeImg.src = "images/hole.png";
        // 배경 이미지
        const backImg = new Image();
        backImg.src = "images/background.jpg";
        // 토끼 이미지 로딩
        const rabbitImg1 = new Image();
        rabbitImg1.src = "images/rabbit_1.png";
        const rabbitImg2 = new Image();
        rabbitImg2.src = "images/rabbit2.png";



        // 로딩됭 이미지를 배열에 넣는다. ( 애니매이션 효과 )
        const rabbitImgs = [rabbitImg1 , rabbitImg2];


        // snipe 의 좌표
        let snipeX = 0 , snipeY = 0;
        // 총알 구멍 객체 (object) 를 저장할 배열
        const holes = [];
        // 토끼 좌표
        let rabbitX=400 , rabbitY=250;
        // 토끼 이미지 인덱스
        let rabbitIndex=0;
        // 카운트 변수
        let count = 0;
        // 효과음 로딩
        const fireSound = new Audio("sounds/fire.wav");
        const dieSound = new Audio("sounds/birddie.mp3");

        setInterval(() => {
            // 함수가 호출 시마다 count 증가
            count++;

            // 함수 내부는 1/100 초마다 1번씩 실행
            //context.clearRect(0 , 0 , 800 , 500);

            // 배경이미지 canvas 에 맞게 그린다.
            context.drawImage(backImg , 0 , 0 , 800 , 500);

            // 총알 구멍 이미지를 반복문으로 돌면서 그린다.
            for(let i = 0; i < holes.length; i++){
                // i 번째 총알 구멍 이미지 정보를 담고 있는 객체 불러오기
                let tmp = holes[i];
                // 안에 담긴 좌표를 이용해 총알 구멍 그리기
                context.drawImage(holeImg , tmp.x-10 , tmp.y-10 , 20 , 20);
            }

            // 토끼 그리기
            context.drawImage(rabbitImgs[rabbitIndex] , rabbitX-50 , rabbitY-50 , 100 , 100);
            // 스나이프 그리기
            context.drawImage(snipeImg , snipeX-50 , snipeY-50 , 100 , 100);

            if(count%20 == 0){
                // 20 번 호출될 때 여기는 한 번만 실행
                // 토끼 이미지 인덱스 1 증가
                rabbitIndex++;
                // 존재하지 않은 인덱스면 0 초기화
                if(rabbitIndex == 2){
                    rabbitIndex = 0;
                }
            }

            // 0 ~ 99 랜덤 정수
            let ranNum = parseInt(Math.random()*100);

            // 50 정수가 나올때만 (확률적으로 1초에 한번)
            if(ranNum == 50){
                // 토끼를 랜덤 위치로 이동
                rabbitX = Math.random() * 700 + 50;
                rabbitY = Math.random() * 400 + 50;
            }
        } , 10);

        // canvas 요소 mousemove 이벤트 처리
        canvas.addEventListener("mousemove" , (e) => {
            // 이벤트가 발생한 곳의 canvas 내에서의 snipeX , snipeY 좌표
            snipeX = e.offsetX;
            snipeY = e.offsetY;
        });

        // canvas 요소 mousedown 이벤트 처리
        canvas.addEventListener("mousedown" , (e) => {
            // mousedown 이벤트가 발생한 곳의 좌표를 변수에 담고 아래에서 2번 활용
            let x = e.offsetX;
            let y = e.offsetY

            // 이벤트 발생한 곳의 좌표를 Object 에 대입
            // const hole = {x:x , y:y};
            const hole = {x , y}; // 위의 표현식을 줄인 표현
            
            // holes 배열에 저장 ( 누적 )
            holes.push(hole);

            // 재생위치를 처음으로 초기화 후
            fireSound.currentTime = 0;

            // 총소리 재생하면 빠르게 마우스를 눌러도 연속 재생 가능
            fireSound.play();

            // 토끼가 총에 맞으면 판별해서 효과음 재생

            let isRabbitDie =   x > rabbitX-50 &&
                                x < rabbitX+50 &&
                                y > rabbitY-50 &&
                                y > rabbitY+50;

            if(isRabbitDie){
                dieSound.currentTime = 0;
                dieSound.play();
            }
        });
    </script>
</body>
</html>